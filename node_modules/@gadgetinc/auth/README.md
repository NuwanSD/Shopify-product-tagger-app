# @gadgetinc/auth

`@gadgetinc/auth` is a `fastify` plugin that helps manage on platform authentication in [Gadget](https://gadget.dev).

## Features

This library implements the following features:

- registers route handlers for OAuth start, callback, and sign out.
- provides a utility for protecting [HTTP routes](https://docs.gadget.dev/guides/http-routes#http-routes) using `preValidation` hooks.
- manages sessions and users in your Gadget app's `user` and `session` model.

## Installation

```shell
yarn add @gadgetinc/auth
# or
npm install --save @gadgetinc/auth
```

## Usage

This plugin can be registered with Gadget in either a [boot plugin](https://docs.gadget.dev/guides/http-routes#boot-plugins) or [route plugin](https://docs.gadget.dev/guides/http-routes#what-routes-do-route-plugins-affect).

To register the plugin:

```typescript
// routes/+auth.js
import { Auth } from "@gadgetinc/auth";
import { api } from "gadget-server";

export default function (server) {
  server.register(Auth, {
    signedInRoles: ["sign-in"],
    api,
    providers: [
      {
        type: "google",
        clientId: process.env.GOOGLE_CLIENT_ID,
        clientSecret: process.env.GOOGLE_CLIENT_SECRET,
      },
    ],
  });
}
```

To protect a route:

```typescript
// routes/GET-protected-route.js
const { preValidation } = require("@gadgetinc/auth");

module.exports = async function ({ reply }) {
  await reply.send("this is a protected route!");
};

module.exports.options = {
  preValidation,
};
```

## Options

Plugin options

- `api` - your Gadget api client
- `signedInRoles` - an array of [roles](https://docs.gadget.dev/guides/access-control#roles) to assign to the authenticated session
- `redirectToSignIn` - if a user is not signed in using the `preValidation` check, then redirect the user to the path specified by `signInPath`. Defaults to `false`
- `signInPath` - the path to your login page. This is where users will be redirected to if `redirectToSignIn` is set to `true`. Defaults to `/signin`
- `providers` - an array of authentication providers
  - `type` - currently the only available type is `"google"`
  - `clientId` - Google OAuth client id
  - `clientSecret` - Google OAuth client secret
  - `scopes` - optional OAuth scopes to request from the user. Defaults to `["email", "profile"]` for Google
  - `transformUser` - by default the plugin will only attempt to set the `user` model's `firstName`, `lastName`, and `email` fields. If you've edited or added more fields and want to customize this behaviour, this function is provided the decoded `id_token` and must - return the input to the `user` model's `create` action.
  - `signedInRoles` - optional if these should differ from the root level `signedInRoles`
